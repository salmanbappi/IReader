name: Preview CI

on:
  workflow_dispatch:
    inputs:
      git-ref:
        description: Git Ref (Optional)
        required: false
      dry-run:
        description: Creates a draft release
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  BuildBinaries:
    name: Build application packages
    strategy:
      matrix:
        runtime: [ android ]
        include:
          - runtime: android
            arch: x64
            os: ubuntu-latest
            shell: bash
            build: :android:assembleStandardPreview
            setupCl: ./.github/scripts/SetupClUnix.sh

    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - name: Clone Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.git-ref || github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: Setup Cl
        run: ${{ matrix.setupCl }}

      - name: Set build metadata
        shell: bash
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          VERSION_NAME=$(grep "versionName =" android/build.gradle.kts | head -n 1 | cut -d'"' -f2 || echo "1.0.0")
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      - name: Build
        uses: gradle/gradle-build-action@v3
        env:
          SUPABASE_AUTH_URL: ${{ secrets.SUPABASE_AUTH_URL }}
          SUPABASE_AUTH_KEY: ${{ secrets.SUPABASE_AUTH_KEY }}
        with:
          arguments: ${{ matrix.build }}

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        if: ${{ matrix.runtime == 'android' }}
        with:
          releaseDirectory: android/build/outputs/apk/standard/preview
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Send APK to Telegram
        if: ${{ matrix.runtime == 'android' }}
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          APK_PATH=$(find android/build/outputs/apk/standard/preview -name "*arm64-v8a*-signed.apk" | head -n 1)
          if [ -f "$APK_PATH" ]; then
            NEW_NAME="IReader-v${{ env.VERSION_NAME }}-r${{ env.COMMIT_COUNT }}-arm64.apk"
            cp "$APK_PATH" "$NEW_NAME"
            COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
            curl -v -F document=@"$NEW_NAME" \
                 -F caption="âœ… *IReader Preview Build Ready*\n\n*Version:* \`${{ env.VERSION_NAME }}\`\n*Revision:* \`r${{ env.COMMIT_COUNT }}\`\n*Commit:* \`$COMMIT_MSG\`\n*Branch:* \`${{ github.ref_name }}\`" \
                 -F parse_mode="Markdown" \
                 "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument?chat_id=${CHAT_ID}"
          else
            echo "APK not found, skipping Telegram upload"
          fi

      - name: Publish Android Artifact
        if: ${{ matrix.runtime == 'android' }}
        uses: actions/upload-artifact@v4
        with:
          name: runner-package-android
          path: android/build/outputs/apk/standard/preview/*-signed.apk

  ReleaseBinaries:
    name: Make a release
    needs: [ BuildBinaries ]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4

      - name: Create Pre-Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "**/*-signed.apk"
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: preview-r$(git rev-list --count HEAD)
          name: IReader Preview Revision $(git rev-list --count HEAD)
          body: "Automated preview build for revision $(git rev-list --count HEAD)"
          prerelease: true
          draft: ${{ github.event.inputs.dry-run == 'true' }}
